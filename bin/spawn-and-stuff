#!/usr/bin/env expect

set to_spawn [lindex $argv 0];
set to_stuff [lindex $argv 1];
set pid [exp_pid];
set cmd_file ~/.config/spawn-and-stuff/${pid}.command;


# Make sure SIGWINCH gets sent down to our spawned process.
# https://stackoverflow.com/questions/45454452/expect-script-fixing-weird-terminal-resizing-behaviour
trap {
    set rows [stty rows]
    set cols [stty columns]
    stty rows $rows columns $cols < $spawn_out(slave,name)
} WINCH

# Whenever we receive a SIGUSR1, read and stuff the contents of /tmp/spawn-and-stuff-commands.txt.
# This is almost certainly a security vulnerability, but it does work!
trap {
    set f [open $cmd_file]
    set cmd [read $f]
    close $f

    send -- "$cmd"
} USR1

spawn -noecho "$to_spawn"
send -- "$to_stuff"
interact
